<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Compressor</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/OpenToolKit/CompressPDF@master/js/pdfkit-standalone-0.10.0.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/OpenToolKit/CompressPDF@master/js/blob-stream-0.1.3.js"></script>

    <style>
        :root { --primary-color: #00b900; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .file-box { border: 2px dashed #ccc; padding: 20px; border-radius: 10px; margin-bottom: 20px; cursor: pointer; transition: 0.3s; }
        .file-box:hover { border-color: var(--primary-color); background: #f9fff9; }
        select, button { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; margin-top: 10px; }
        button { background-color: var(--primary-color); color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        #status { margin-top: 15px; font-size: 13px; color: #666; white-space: pre-line; line-height: 1.6; }
        #fileDisplayName { margin-top: 10px; font-size: 14px; color: var(--primary-color); font-weight: bold; text-align: left; max-height: 80px; overflow-y: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ */
        .page-count { color: #008b00; font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>

<div class="container">
    <h2>üè• ‡∏¢‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå PDF</h2>
    
    <div class="file-box" onclick="document.getElementById('pdfInput').click()">
        <span id="fileNameHint">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</span>
        <input type="file" id="pdfInput" accept=".pdf" multiple style="display:none">
        <div id="fileDisplayName"></div>
    </div>

    <label style="font-size: 13px; color: #888; display: block; text-align: left;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</label>
    <select id="quality">
        <option value="0.3">‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å (‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)</option>
        <option value="0.5" selected>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
        <option value="0.8">‡∏ä‡∏±‡∏î‡∏°‡∏≤‡∏Å (‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤)</option>
    </select>

    <button id="btnCompress">‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
    
    <div class="loader" id="loader"></div>
    <div id="status"></div>

    <canvas id="tempCanvas" style="display:none;"></canvas>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    document.getElementById('pdfInput').onchange = function() {
        const files = this.files;
        const display = document.getElementById('fileDisplayName');
        if (files.length > 0) {
            let names = Array.from(files).map(f => "‚Ä¢ " + f.name).join("<br>");
            display.innerHTML = `<div style="margin-bottom:5px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${files.length} ‡πÑ‡∏ü‡∏•‡πå:</div>` + names;
            document.getElementById('fileNameHint').innerText = "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå";
        } else {
            display.innerHTML = "";
            document.getElementById('fileNameHint').innerText = "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)";
        }
    };

    function autoDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö status element ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤
    const processSingleFile = (file, quality, fileIndex, totalFiles, statusElement) => {
        return new Promise(async (resolve, reject) => {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const doc = new PDFDocument({ autoFirstPage: false });
                const stream = doc.pipe(blobStream());
                const canvas = document.getElementById('tempCanvas');
                const ctx = canvas.getContext('2d');

                for (let i = 1; i <= pdf.numPages; i++) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ö‡∏ö Real-time
                    statusElement.innerHTML = `üìÑ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà ${fileIndex}/${totalFiles}: <br><b>${file.name}</b><br><br>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤ <span class="page-count">${i}</span> ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${pdf.numPages} ‡∏´‡∏ô‡πâ‡∏≤`;
                    
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    const imgData = canvas.toDataURL('image/jpeg', quality);
                    doc.addPage({ size: [viewport.width, viewport.height] });
                    doc.image(imgData, 0, 0, { width: viewport.width, height: viewport.height });
                }

                doc.end();
                stream.on('finish', () => {
                    const blob = stream.toBlob('application/pdf');
                    autoDownload(blob, `Small_${file.name}`);
                    resolve();
                });
            } catch (err) { reject(err); }
        });
    };

    document.getElementById('btnCompress').onclick = async () => {
        const fileInput = document.getElementById('pdfInput');
        const quality = parseFloat(document.getElementById('quality').value);
        const status = document.getElementById('status');
        const loader = document.getElementById('loader');
        const btn = document.getElementById('btnCompress');

        if (fileInput.files.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

        btn.disabled = true;
        loader.style.display = "block";

        try {
            const files = Array.from(fileInput.files);
            for (let i = 0; i < files.length; i++) {
                // ‡∏™‡πà‡∏á parameter ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                await processSingleFile(files[i], quality, i + 1, files.length, status);
            }
            status.innerHTML = `<span style="color:var(--primary-color); font-weight:bold;">‚úÖ ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á ${files.length} ‡πÑ‡∏ü‡∏•‡πå!</span>`;
        } catch (error) {
            status.innerHTML = `<span style="color:red">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>`;
            console.error(error);
        } finally {
            btn.disabled = false;
            loader.style.display = "none";
        }
    };
</script>

</body>
</html>
